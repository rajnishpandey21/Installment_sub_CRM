<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>KPI Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font-family:'Poppins', sans-serif; background:#f4f7f6; color: #333; }
    .header { background:#1434A4; color: white; padding:15px 30px; font-weight:700; display:flex; justify-content:space-between; align-items: center; }
    .wrap { padding:20px; max-width:1600px; margin:0 auto; }
    .controls { display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:20px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .controls input { padding:10px; border:1px solid #ccc; border-radius:6px; font-family:'Poppins', sans-serif; }
    .btn { padding:10px 18px; background:#FFC107; color:#111; border:none; font-weight:700; cursor:pointer; border-radius: 9999px; transition: transform 0.08s ease, background-color 0.15s ease, box-shadow 0.15s ease; font-family:'Poppins', sans-serif; box-shadow:0 2px 6px rgba(0,0,0,0.12); }
    .btn:hover { background: #E0AB06; transform: translateY(-1px); }
    .btn:active { background: #C99705; transform: translateY(0); }
    .btn:disabled { background: #EAD48A; cursor: not-allowed; }
    .kpi-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:20px; }
    .card { background:#fff; border-radius:8px; padding:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .card .title { font-size: 1rem; color: #555; margin-bottom: 10px; }
    .card .value { font-size: 2.5rem; font-weight: 700; color: #1434A4; }
    .card .subtext { font-size: 0.8rem; color: #777; margin-top:5px;}
    h2 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 40px; color: #1434A4;}
    .status { font-weight: 600; margin-left: 15px; }
    .day-card { background: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); margin-bottom: 15px; }
    .day-header { font-weight: 700; font-size: 1.2rem; margin-bottom: 10px; }
    .disposition-table { width: 100%; border-collapse: collapse; margin-top:10px; }
    .disposition-table th, .disposition-table td { padding: 8px; text-align: left; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="header">
    <div>KPI Dashboard</div>
    <div id="centreName">Centre</div>
  </div>
  <div class="wrap">
    <div class="controls">
      <input type="date" id="from" />
      <input type="date" id="to" />
      <button class="btn" id="btnRun">Run Report</button>
      <div id="status" class="status"></div>
    </div>

    <h2>High-Level Summary</h2>
    <div class="kpi-grid">
      <div class="card"><div class="title">Total Assigned</div><div class="value" id="total-assigned">-</div><div class="subtext">Leads needing action in period</div></div>
      <div class="card"><div class="title">Total Actioned</div><div class="value" id="total-actioned">-</div><div class="subtext">Unique leads contacted</div></div>
      <div class="card"><div class="title">Total Due (Missed)</div><div class="value" id="total-due">-</div><div class="subtext">Assigned but not actioned</div></div>
      <div class="card"><div class="title">Completion Rate</div><div class="value" id="total-completion">-</div><div class="subtext">Actioned / Assigned</div></div>
    </div>

    <h2 id="details-header">Daily Breakup</h2>
    <div id="reportDetails"></div>
  </div>

<script>
    (function(){
      var API_BASE = 'https://script.google.com/macros/s/AKfycbwguUkMt32RtWsIvBODnHo0HZEF-3B8CD0TCdzq8utulDQfQSkUlzX8FUCHZJMwuO6Wow/exec';
      function getQueryParam(name) {
        var params = new URLSearchParams(window.location.search);
        return params.get(name) || '';
      }
      var center = getQueryParam('center');
      var employeeCode = getQueryParam('employeeCode');

      var fromEl = document.getElementById('from');
      var toEl = document.getElementById('to');
      var btnRun = document.getElementById('btnRun');
      var statusEl = document.getElementById('status');
      var reportDetailsEl = document.getElementById('reportDetails');
      var detailsHeader = document.getElementById('details-header');
      var centreNameDisplay = document.getElementById('centreName');
      fromEl.min = '2025-10-15';
      toEl.min = '2025-10-15';

      if (!center || !employeeCode) {
        alert('Could not identify user. Please log in again.');
        return;
      }
      
      centreNameDisplay.textContent = center;

      function fetchJson(url) {
        statusEl.textContent = 'Loading Report...';
        btnRun.disabled = true;
        return fetch(url).then(r => r.json()).finally(() => {
          statusEl.textContent = '';
          btnRun.disabled = false;
        });
      }

      function renderReport(report) {
        let totalAssigned = 0, totalActioned = 0, totalDue = 0;
        reportDetailsEl.innerHTML = '';
        var sortedDates = Object.keys(report).sort((a, b) => new Date(b) - new Date(a));

        if (sortedDates.length === 0) {
          statusEl.textContent = 'No data found for this period.';
          detailsHeader.textContent = 'Daily Breakup';
          document.getElementById('total-assigned').textContent = '0';
          document.getElementById('total-actioned').textContent = '0';
          document.getElementById('total-due').textContent = '0';
          document.getElementById('total-completion').textContent = '0.0%';
          return;
        }

        sortedDates.forEach(date => {
            const dayData = report[date] ? report[date][employeeCode] : null;

            if (!dayData) return;

            dayData.dueActionsCount = dayData.assignedCount - dayData.actionedCount;
            dayData.completionPercentage = dayData.assignedCount > 0 ? (dayData.actionedCount / dayData.assignedCount) * 100 : 0;
            
            totalAssigned += dayData.assignedCount;
            // ### THIS IS THE FIX ###
            // Corrected "day_data" to "dayData"
            totalActioned += dayData.actionedCount;
            totalDue += dayData.dueActionsCount;

            /*
            let dispositionHtml = 'No actions taken.';
            if (Object.keys(dayData.dispositions).length > 0) {
                dispositionHtml = '<table class="disposition-table"><thead><tr><th>Disposition</th><th>Count</th></tr></thead><tbody>';
                for (const [action, count] of Object.entries(dayData.dispositions)) {
                    dispositionHtml += `<tr><td>${action}</td><td>${count}</td></tr>`;
                }
                dispositionHtml += '</tbody></table>';
            }
            */
            reportDetailsEl.innerHTML += `
              <div class="day-card">
                <div class="day-header">${new Date(date + 'T00:00:00').toLocaleDateString('en-GB', { weekday: 'long', month: 'long', day: 'numeric' })}</div>
                <div class="kpi-grid">
                  <div class="card"><div class="title">Assigned</div><div class="value">${dayData.assignedCount}</div></div>
                  <div class="card"><div class="title">Actioned</div><div class="value">${dayData.actionedCount}</div></div>
                  <div class="card"><div class="title">Due (Missed)</div><div class="value">${dayData.dueActionsCount}</div></div>
                  <div class="card"><div class="title">Completion</div><div class="value">${dayData.completionPercentage.toFixed(1)}%</div></div>
                </div>
              </div>`;
        });
        
        const totalCompletion = totalAssigned > 0 ? `${((totalActioned / totalAssigned) * 100).toFixed(1)}%` : '0.0%';
        document.getElementById('total-assigned').textContent = totalAssigned;
        document.getElementById('total-actioned').textContent = totalActioned;
        document.getElementById('total-due').textContent = totalDue;
        document.getElementById('total-completion').textContent = totalCompletion;
        detailsHeader.textContent = `Daily Breakup (${sortedDates.length} days)`;
      }
      
      function runReport() {
        var from = fromEl.value;
        var to = toEl.value;
        
        if (!from || !to) {
            statusEl.textContent = 'Please select a valid date range.';
            return;
        }
        
        var url = `${API_BASE}?action=advancedreportv2&center=${encodeURIComponent(center)}&from=${from}&to=${to}&employeeCode=${encodeURIComponent(employeeCode)}`;
        
        fetchJson(url).then(data => {
            if (data.ok) {
                renderReport(data.report);
                statusEl.textContent = 'Report loaded successfully!';
            } else {
                statusEl.textContent = `Error: ${data.error || 'Unknown error'}`;
            }
        }).catch(() => statusEl.textContent = 'Failed to fetch report.');
      }

      btnRun.addEventListener('click', runReport);

      var toDate = new Date();
      var fromDate = new Date();
      fromDate.setDate(toDate.getDate() - 6);
      toEl.value = toDate.toISOString().slice(0, 10);
      fromEl.value = fromDate.toISOString().slice(0, 10);
      
      runReport();

    })();
</script>
</body>
</html>